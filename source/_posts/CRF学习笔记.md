---
title: CRF学习笔记
date: 2017-06-13 20:41:21
tags: CRF
categories: 学习
---

# CRF的学习笔记

> 本文是针对《统计学习方法》第11章相关部分的纠错和更为详细的说明。

## 条件随机场的矩阵形式

假设现有一个线性链条件随机场$P\_w(y|x)=\frac{1}{Z(x)}\exp\sum\_{k=1}^K w\_k f\_k(y,x)$，其中$Z(x)=\sum\_y \exp \sum\_{k=1}^K w\_k f\_k(y,x)$。

表示对给定观测序列x，相应的标记序列y的条件概率。引进特殊的起点和终点状态标记$y\_0=start, y\_{n+1}=stop$，这时条件随机场可以通过矩阵形式表示。

对观测序列x的每一个位置$i=1,2,\cdots ,n+1$上，定义一个m阶矩阵（m是标记y的取值个数，包括start和stop）

$$M\_i(x)=[M\_i(y\_{i-1},y\_i|x)] \\
M\_i(y\_{i-1},y\_i|x) = \exp(W\_i(y\_{i-1},y\_i|x)) \\
W\_i(y\_{i-1},y\_i|x) = \sum\_{k=1}^K w\_k f\_k(y\_{i-1},y\_i,x,i)$$

这样，给定观测序列x，标记序列y的非规范化概率可以通过n+1个矩阵的乘积$\prod\_{i=1}^{n+1}M\_i(y\_{i-1},y\_i|x)$表示，于是条件概率$P\_w(y|x)$是：

$$P\_w(y|x)=\frac{1}{Z\_w(x)}\prod\_{i=1}^{n+1}M\_i(y\_{i-1},y\_i|x)$$

其中，$Z\_w(x)$为规范化因子，是n+1个矩阵的乘积的(start, stop)元素：

$$Z\_w(x)=\left( \prod\_{i=1}^{n+1}M\_i(x)\right)\_{start,stop}$$

【例1】给定如下图所示的线性链条件随机场，

![状态路径](http://7xnh8y.com1.z0.glb.clouddn.com/%E7%8A%B6%E6%80%81%E8%B7%AF%E5%BE%84.png)

观测序列x，状态序列y，i=1,2,3，n=3，标记$y\_i\in \{1,2\}$，假设$y\_0=start=0, y\_4=stop=3$，各个位置的随机矩阵$M\_1(x),M\_2(x),M\_3(x),M\_4(x)$分别为是

![m_matrices_crf](http://7xnh8y.com1.z0.glb.clouddn.com/m_matrix_crf.png)

试求状态序列y以start为起点到stop为终点的所有路径的非规范化概率及规范化因子。

解：这部分其实非常好求，直接利用给定的公式得到

![final_m_matrix](http://7xnh8y.com1.z0.glb.clouddn.com/final_m_matrix_crf.png)

其中

$$Z\_(x) =a\_{01}b\_{11}c\_{11}+a\_{01}b\_{11}c\_{12}+a\_{01}b\_{12}c\_{21}+a\_{01}b\_{12}c\_{22} + a\_{02}b\_{21}c\_{11}+a\_{02}b\_{21}c\_{12}+a\_{02}b\_{22}c\_{21}+a\_{02}b\_{22}c\_{22}$$

即所以路径非规范化概率和。



## 条件随机场的概率计算

### 前向-后向算法

> 这里的概率计算是指，对给定观测序列x及标记序列y，可以通过前向后向算法求出任意一个位置上$y\_i$是某个标记的条件概$P(y\_i=u|x)$，或任意连续的两个位置$y\_{i-1},y\_i$上的条件概率$P(y\_{i-1}=u,y\_i=v|x)$。
>
> **注意：不是求一条解码序列的概率。**

#### 前向向量

对每个位置$i=0,1,\cdots ,n+1$，定义前向向量$\alpha\_i(x)$(行向量):

![fw_vec_define](http://7xnh8y.com1.z0.glb.clouddn.com/forward_vec_crf.png)

递推公式为

$$\alpha\_i(y\_i|x)=\alpha\_{i-1}(y\_{i-1}|x)M\_i(y\_{i-1},y\_i|x) \text{, }(i=1,2,\cdots,n+1)$$

又可以表示为：

$$\alpha\_i(x)=\alpha\_{i-1}(x)M\_i(x)$$

$\alpha\_i(y\_i|x)$表示在位置i的标记是$y\_i$并且到位置i的前部分标记序列的非规范化概率，$y\_i$可取的值有m个。

#### 后向向量

同样，对每个位置$i=0,1,\cdots ,n+1$，定义后向向量$\beta\_i(x)$(列向量):

![bw_vec_define](http://7xnh8y.com1.z0.glb.clouddn.com/backward_vec_crf.png)

递推公式为

$$\beta\_i(y\_i|x)=M\_{i+1}(y\_i,y\_{i+1}|x)\beta\_{i+1}(y\_{i+1}|x) \text{, }(i=0,1,\cdots,n)$$

又可以表示为：

$$\beta\_i(x)=\beta\_{i+1}(x)M\_{i+1}(x)$$

$\beta\_i(y\_i|x)$表示在位置i的标记是$y\_i$并且到$i+1$到n的后部分标记序列的非规范化概率。

------

由前向后向向量的定义不难得到：

$$Z(x)=\alpha\_{n+1}(x)\cdot \mathbf{1}=\mathbf{1}^T \cdot \beta\_0(x)$$

这里，$\mathbf{1}$是元素均为1的m维列向量。

【例2】使用【例1】中的条件随机场，计算其前向向量和后向向量。

答：（1）计算前向向量

$\alpha\_0(x)=[1,0,0,0]$

$\alpha\_1(x) = \alpha\_0(x)M\_1(x)=[0,a\_{01},a\_{02}, 0]$

$\alpha\_2(x) = \alpha\_1(x)M\_2(x)=[0,a\_{01}b\_{11}+a\_{02}b\_{21},a\_{01}b\_{12}+a\_{02}b\_{22}, 0]$

$\alpha\_3(x) = \alpha\_2(x)M\_3(x)=[0,(a\_{01}b\_{11}+a\_{02}b\_{21}) \cdot c\_{11}+(a\_{01}b\_{12}+a\_{02}b\_{22}) \cdot c\_{21}, (a\_{01}b\_{11}+a\_{02}b\_{21}) \cdot c\_{12}+(a\_{01}b\_{12}+a\_{02}b\_{22}) \cdot c\_{22},0]$

$\alpha\_4(x)=[0,0,0,Z(x)]$

(2)计算后向向量

$\beta\_4(x) = [0,0,0,1]^T$

$\beta\_3(x)=M\_4(x)\beta\_4(x)=[0,1,1,0]^T$

$\beta\_2(x)=M\_3(x)\beta\_3(x)=[0,c\_{11}+c\_{12},c\_{21}+c\_{22},0]^T$

$\beta\_1(x)=M\_2(x)\beta\_2(x)=[0,b\_{11}(c\_{11}+c\_{12})+b\_{12}(c\_{21}+c\_{22}),b\_{21}(c\_{11}+c\_{12})+b\_{22}(c\_{21}+c\_{22}),0]^T$

$\beta\_0(x)=M\_1(x)\beta\_1(x)=[Z(x),0,0,0]^T$

### 概率计算

按照前向-后向向量的定义，很容易计算标记序列在位置i是标记$y\_i$的条件概率和在位置i-1与i是标记$y\_{i-1}$和$y\_i$的条件概率：

$$P(Y\_i=y\_i|x)=\frac{\alpha\_i(y\_i|x) \beta\_i(y\_i|x)}{Z(x)}$$

$$P(Y\_{i-1}=y\_{i-1}, Y\_i=y\_i|x)=\frac{\alpha\_{i-1}(y\_{i-1}|x)M\_i(y\_{i-1},y\_i|x)\beta\_i(y\_i|x)}{Z(x)}$$

【例3】计算【例1】中条件随机场的条件概率$P(y\_1=1|x)$和$P(y\_1=1,y\_2=2|x)$：

解：（1）求条件概率$P(y\_1=1|x)=\frac{\alpha\_1(y\_1=1|x) \beta\_1(y\_1=1|x)}{Z(x)}$

已知:

$\alpha\_1(x) =[0,a\_{01},a\_{02}, 0]$，

$\beta\_1(x)=M\_2(x)\beta\_2(x)=[0,b\_{11}(c\_{11}+c\_{12})+b\_{12}(c\_{21}+c\_{22}),b\_{21}(c\_{11}+c\_{12})+b\_{22}(c\_{21}+c\_{22}),0]^T$则有：

$\alpha\_1(y\_1=1|x)=a\_{01}$

$\beta\_1(y\_1=1|x)=b\_{11}(c\_{11}+c\_{12})+b\_{12}(c\_{21}+c\_{22})=b\_{11}c\_{11}+b\_{11}c\_{12}+b\_{12}c\_{21}+b\_{12}c\_{22}$

所以
$$P(y\_1=1|x)=\frac{a\_{01}(b\_{11}c\_{11}+b\_{11}c\_{12}+b\_{12}c\_{21}+b\_{12}c\_{22})}{Z(x)}$$

分子也即所有位置i=1上y为1的路径的非规范概率和。

（2）求条件概率$P(y\_1=1,y\_2=2|x)=\frac{\alpha\_1(y\_1=1|x)M\_2(y\_1=1,y\_2=2|x)\beta\_2(y\_2=2|x)}{Z(x)}$

已知:$\alpha\_1(y\_1=1|x)=a\_{01}$, $M\_2(y\_1=1,y\_2=2|x)=b\_{12}$, $\beta\_2(y\_2=2|x)=c\_{21}+c\_{22}$

所以

$$P(y\_1=1,y\_2=2|x)=\frac{a\_{01} \cdot b\_{12} \cdot (c\_{21}+c\_{22})}{Z(x)}$$